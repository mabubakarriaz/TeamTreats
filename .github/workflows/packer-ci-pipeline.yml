name: CI Packer Pipeline
on:
  pull_request:
    types: [opened, reopened, edited, synchronize]
    paths: 
      #- '.github/workflows/packer-ci-pipeline.yml'
      - 'configs/packer/**' # pre double asterisk means root dir. post double asterisk means sub-directories
      - 'packer.json' # pre double asterisk means root dir. post double asterisk means sub-directories

env:
  TT_ARTIFACT_NAME: packer-lin-x64 
  TT_VERSION: "v0.${{ github.run_number }}.${{ github.run_attempt }}"
  TT_VERSION_SEMANTIC: "v0.${{ github.run_number }}.${{ github.run_attempt }}-${{ github.head_ref }}"

jobs:
  validate:
    name: check-packer-lint
    runs-on: ubuntu-22.04 # Debian distro Ubuntu 22.04.3 LTS
    defaults:
      run:
        shell: bash

    env:
      # project paths
      TT_PACKER_PATH: 'packer.json'

      #versions
      ANSIBLE_VERSION: '2.10.7+merged+base+2.10.8+dfsg-1'
      ANSIBLE_LINT_VERSION: '6.14.2'
      
    steps:
      # download source code from the repo that resides in pushed branch only
      - name: Import source code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }} # the name of the branch that triggered the push 

      - name: Set up Packer
        uses: hashicorp/setup-packer@main
        with:
          version: latest

      - name: Validate Packer syntax
        run: packer validate -syntax-only ${{ env.TT_PACKER_PATH }}
      
      - name: Validate Packer file
        run: packer validate ${{ env.TT_PACKER_PATH }}
